
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gloves Manufacture Company</title>
  <style>
    /* VARIABLES */
    :root{
      --bg:#f0f8ff; --card:#ffffff; --text:#1e3a8a; --muted:#4b5563; --accent:#3b82f6; --border:#bfdbfe; --ok:#10b981;
      --accent2:#ef4444; --accent3:#f59e0b; --header-bg:#dbeafe;
    }
    :root.dark{
      --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#60a5fa; --border:#1f2937; --ok:#22c55e;
      --accent2:#f87171; --accent3:#fbbf24; --header-bg:#1e3a8a;
    }
    /* BASE STYLES */
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji"}
    header, footer{padding:14px 18px}
    header{background:var(--header-bg);border-bottom:1px solid var(--border);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 4px 6px rgba(0,0,0,0.05)}
    h1{font-size:22px;margin:0;color:var(--accent)}
    h2{font-size:18px;margin:0 0 8px 0;color:var(--accent)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="number"], input[readonly], input[type="text"], input[type="tel"], input[type="date"], textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:16px}
    input[readonly]{background:rgba(127,127,127,.05)}
    .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer;transition:all 0.2s ease;font-size:14px}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:white}
    .btn.success{background:var(--ok);border-color:var(--ok);color:white}
    .btn.warn{background:var(--accent2);border-color:var(--accent2);color:white}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.1)}
    table{width:100%;border-collapse:collapse;}
    th, td{border-bottom:1px solid var(--border);padding:8px;text-align:center}
    th{font-weight:600;color:var(--muted);background:var(--header-bg)}
    tfoot td{font-weight:700}
    .note{font-size:12px;color:var(--muted)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(59,130,246,.1);color:var(--accent);font-size:12px}
    .pill.orange{background:rgba(245,158,11,.1);color:var(--accent3)}
    .pill.red{background:rgba(239,68,68,.1);color:var(--accent2)}
    .footer{font-size:13px;color:var(--muted);border-top:1px solid var(--border);text-align:center}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .card-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .totals{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .mono{font-variant-numeric:tabular-nums;}
    .user-info{display:grid;grid-columns:repeat(auto-fit, minmax(300px, 1fr));gap:12px;margin-bottom:16px;}
    .date-container{display:flex;gap:8px;}
    
    /* NEW STYLES */
    .payment-details {
      display: grid;
      grid-template-columns: 1fr 1.5fr 1fr auto;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .payment-date {
      min-width: 120px;
    }
    .payment-note {
      min-width: 150px;
    }
    .centered-cell {
      text-align: center;
    }
    .payment-summary {
      background: rgba(16, 185, 129, 0.1);
      padding: 8px 12px;
      border-radius: 8px;
      margin-top: 10px;
      border-left: 3px solid var(--ok);
    }
    
    /* Colorful elements for light mode */
    :root .panel:nth-child(3n+1) {border-top: 3px solid var(--accent);}
    :root .panel:nth-child(3n+2) {border-top: 3px solid var(--accent3);}
    :root .panel:nth-child(3n+3) {border-top: 3px solid var(--accent2);}
    
    /* Payment section styles */
    .payment-section {margin-top: 20px; padding-top: 15px; border-top: 1px dashed var(--border);}
    .payment-row {display: flex; gap: 10px; margin-bottom: 10px; align-items: center;}
    .payment-row input, .payment-row select {flex: 1;}
    .payment-row .btn {flex: 0 0 auto;}
    
    /* NEW: Combined user info section */
    .combined-user-info {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 20px;
        align-items: center;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 20px;
        margin-bottom: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .user-details-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    .user-info-item {
        display: flex;
        flex-direction: column;
    }
    .totals .panel {
        text-align: left;
    }
    
    /* Specific styles for the two special total boxes */
    .panel.total-info-box {
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: left !important;
    }

    .panel.total-info-box input {
        text-align: left !important;
    }

    .deducting-payments {
        font-size: 13px;
        color: var(--muted);
        margin-top: 5px;
    }
    
    .final-amount-label {
        margin-top: 10px;
    }

    /* Professional Image Styling */
    .profile-img-container {
      position: relative;
      width: 100px;
      height: 100px;
      flex-shrink: 0;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid var(--accent);
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .profile-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .profile-upload-btn {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 30px;
      height: 30px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      line-height: 1;
      cursor: pointer;
      border: 2px solid var(--card);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* Mobile specific styles */
    @media (max-width: 768px) {
      .grid{grid-template-columns:repeat(2,1fr)}
      .totals{grid-template-columns:repeat(2,1fr)}
      header .wrap{gap:8px;}
      .right{gap:6px;}
      .btn{padding:8px 10px;font-size:13px;}
      h1{font-size:18px;}
      .user-info{grid-template-columns:1fr;}
      .payment-row {flex-direction: column; align-items: stretch;}
      .payment-details {grid-template-columns: 1fr; gap: 8px;}
      
      /* New combined user info on mobile */
      .combined-user-info {
        grid-template-columns: 1fr;
        text-align: center;
      }
      .user-details-grid {
        grid-template-columns: 1fr;
      }
      .profile-img-container {
        margin: 0 auto; /* Center image on mobile */
      }
      
      /* Updated Monthly Sheet Table Mobile View - No horizontal scroll */
      .mobile-table-container {
        overflow-x: hidden; /* Prevent horizontal scroll */
      }
      
      /* New: Make table cells responsive */
      .monthly-sheet-table {
          width: 100%; /* Ensure table takes full width */
          table-layout: fixed; /* Fix column widths */
      }

      .monthly-sheet-table th, .monthly-sheet-table td {
          word-wrap: break-word; /* Allow content to wrap */
          padding: 4px; /* Reduce padding for smaller screens */
      }

      /* Reduce font size for readability on small screens */
      .monthly-sheet-table th, .monthly-sheet-table td, .monthly-sheet-table input {
          font-size: 10px;
      }
      
      /* Adjust column widths to fit */
      .monthly-sheet-table th:first-child, .monthly-sheet-table td:first-child {
          width: 10%; /* Date */
      }
      .monthly-sheet-table th:nth-child(2), .monthly-sheet-table td:nth-child(2),
      .monthly-sheet-table th:nth-child(3), .monthly-sheet-table td:nth-child(3),
      .monthly-sheet-table th:nth-child(4), .monthly-sheet-table td:nth-child(4) {
          width: 15%; /* Quantity columns */
      }
      .monthly-sheet-table th:nth-child(5), .monthly-sheet-table td:nth-child(5) {
          width: 25%; /* Total Amount */
      }
      .monthly-sheet-table th:last-child, .monthly-sheet-table td:last-child {
          width: 25%; /* Note */
      }
      
      /* Make quantity inputs larger */
      .monthly-sheet-table input[type="number"] {
          width: 50px; /* Better size for input */
          height: 30px; /* Consistent height */
          font-size: 12px; /* Readable font size */
      }
    }

    @media (max-width: 480px) {
      .grid{grid-template-columns:1fr}
      .totals{grid-template-columns:1fr}
      .wrap{padding:12px;}
      header, footer{padding:10px 12px;}
      .panel{padding:12px;}
      .btn{width:100%;margin-bottom:4px;}
      .right{flex-direction:column;width:100%;}
      .date-container{flex-direction:column;gap:6px;}
    }

    /* NEW: Center align inputs in table cells */
    .table-input-cell input {
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;gap:14px;justify-content:space-between;flex-wrap:wrap;">
      <h1>Gloves Manufacture Company</h1>
      <div class="right">
        <button id="themeToggle" class="btn" title="Light/Dark">üåô / ‚òÄÔ∏è</button>
        <button id="exportBtn" class="btn">Export JSON</button>
        <label class="btn" for="importFile" title="Import JSON">Import JSON <input id="importFile" type="file" accept="application/json" style="display:none"/></label>
        <button id="downloadImageBtn" class="btn">Download Image</button>
        <button id="resetBtn" class="btn warn">Reset Month</button>
      </div>
    </div>
  </header>

  <main class="wrap" id="mainContent">
    <!-- Combined User Info Section -->
    <div class="combined-user-info">
      <div class="profile-img-container">
        <img id="profileImage" src="https://via.placeholder.com/100" class="profile-img" alt="Profile Image">
        <label for="profileUpload" class="profile-upload-btn">+</label>
        <input type="file" id="profileUpload" accept="image/*" style="display: none;">
      </div>
      <div class="user-details-grid">
        <div class="user-info-item">
            <label for="userName">Personal Name (Naam)</label>
            <input type="text" id="userName" placeholder="Enter your name" />
        </div>
        <div class="user-info-item">
            <label for="mobileNumber">Mobile Number (Mobile No.)</label>
            <input type="tel" id="mobileNumber" placeholder="Enter mobile number" />
        </div>
        <div class="user-info-item">
            <label>Month & Year (Mahina aur Saal)</label>
            <div class="date-container">
                <select id="monthSelect" style="flex:1;">
                    <option value="0">January</option>
                    <option value="1">February</option>
                    <option value="2">March</option>
                    <option value="3">April</option>
                    <option value="4">May</option>
                    <option value="5">June</option>
                    <option value="6">July</option>
                    <option value="7">August</option>
                    <option value="8">September</option>
                    <option value="9">October</option>
                    <option value="10">November</option>
                    <option value="11">December</option>
                </select>
                <input type="number" id="yearInput" min="2020" max="2100" value="2025" style="flex:1;" />
            </div>
        </div>
        <div class="user-info-item">
            <label for="previousBalance">Previous Balance (Sabqa Raqam)</label>
            <input type="number" id="previousBalance" min="0" step="0.01" placeholder="0.00" />
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Rates & Quick Calculator (Bora/Bori ‚Üí 60 Dozen each)</h2>
      <p class="note">Payment har <b>bori</b> = <span class="pill">rate √ó 60 dozen</span>. Neechay quantity (bori) likhein ‚Äî jawab khud aa jayega.</p>
      <div class="grid">
        <div class="panel col">
          <div class="card-title"><strong>Rate: 4.25</strong> <span class="pill">√ó 60</span></div>
          <label>Quantity (Bori)</label>
          <input id="q425Quick" type="number" min="0" step="1" placeholder="e.g., 2" />
          <label>Amount</label>
          <input id="a425Quick" type="text" readonly class="mono" placeholder="0.00" />
        </div>
        <div class="panel col">
          <div class="card-title"><strong>Rate: 4.75</strong> <span class="pill orange">√ó 60</span></div>
          <label>Quantity (Bori)</label>
          <input id="q475Quick" type="number" min="0" step="1" placeholder="e.g., 3" />
          <label>Amount</label>
          <input id="a475Quick" type="text" readonly class="mono" placeholder="0.00" />
        </div>
        <div class="panel col">
          <div class="card-title"><strong>Rate: 6.00</strong> <span class="pill red">√ó 60</span></div>
          <label>Quantity (Bori)</label>
          <input id="q600Quick" type="number" min="0" step="1" placeholder="e.g., 1" />
          <label>Amount</label>
          <input id="a600Quick" type="text" readonly class="mono" placeholder="0.00" />
        </div>
        <div class="panel col">
          <div class="card-title"><strong>Grand Total</strong> <span class="pill" style="background:rgba(16,185,129,.1);color:var(--ok)">All Rates</span></div>
          <label>Total Bories</label>
          <input id="totalBoriesQuick" type="text" readonly class="mono" placeholder="0" />
          <label>Total Amount</label>
          <input id="totalAmountQuick" type="text" readonly class="mono" placeholder="0.00" />
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Monthly Sheet (Monthly Sheet)</h2>
      <p class="note">Har din ke liye teen rates par <b>bori</b> quantity add karein. Amount apnay aap niklay gi. Data aapke browser me autosave hota rehta hai (offline bhi chalega).</p>
      <div class="mobile-table-container">
        <table id="monthTable" class="monthly-sheet-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Qty @ 4.25</th>
              <th>Qty @ 4.75</th>
              <th>Qty @ 6.00</th>
              <th>Total Amount</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td>Monthly Total</td>
              <td id="sumQ425" class="mono">0</td>
              <td id="sumQ475" class="mono">0</td>
              <td id="sumQ600" class="mono">0</td>
              <td id="sumDay" class="mono">0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="panel">
      <h2>Payments (Adjusted) (Payments (Adjusted))</h2>
      <p class="note">Yahan weekly payments add karein jo grand total se minus ho jayen gi.</p>
      <div id="paymentsContainer">
        <!-- Payments will be added here dynamically -->
      </div>
      <div class="payment-row">
        <input type="date" id="newPaymentDate" />
        <input type="number" id="newPaymentAmount" placeholder="Payment amount" step="0.01" min="0" />
        <input type="text" id="newPaymentNote" placeholder="Payment note (e.g., Week 1)" />
        <button id="addPaymentBtn" class="btn primary">Add Payment</button>
      </div>
    </div>

    <div class="panel">
      <h2>Totals (Poora Mahina)</h2>
      <div class="totals">
        <div class="panel">
          <div class="card-title"><strong>Total Qty @ 4.25</strong></div>
          <input id="totalQ425" type="text" readonly class="mono" />
          <label>Total Amount</label>
          <input id="totalA425" type="text" readonly class="mono" />
        </div>
        <div class="panel">
          <div class="card-title"><strong>Total Qty @ 4.75</strong></div>
          <input id="totalQ475" type="text" readonly class="mono" />
          <label>Total Amount</label>
          <input id="totalA475" type="text" readonly class="mono" />
        </div>
        <div class="panel">
          <div class="card-title"><strong>Total Qty @ 6.00</strong></div>
          <input id="totalQ600" type="text" readonly class="mono" />
          <label>Total Amount</label>
          <input id="totalA600" type="text" readonly class="mono" />
        </div>
        <div class="panel">
          <div class="card-title"><strong>Grand Total</strong></div>
          <input id="grandTotal" type="text" readonly class="mono" />
          <label>Previous Balance</label>
          <input id="prevBalanceDisplay" type="text" readonly class="mono" />
        </div>
        <div class="panel total-info-box">
          <div class="card-title"><strong>Total Payments</strong></div>
          <label class="deducting-payments">Deducting Payments</label>
          <input id="totalPayments" type="text" readonly class="mono" />
          <label class="final-amount-label">Net Cash | Final Amount</label>
          <input id="finalAmount" type="text" readonly class="mono" />
          <div class="payment-summary">
            <small>After deducting weekly payments</small>
          </div>
        </div>
        <div class="panel total-info-box">
          <div class="card-title"><strong>Last Saved</strong></div>
          <input id="lastSaved" type="text" readonly class="mono" />
          <label>Status</label>
          <input id="statusIndicator" type="text" readonly value="All changes saved" />
        </div>
      </div>
    </div>
    
    <!-- NEW SECTION FOR TIPS -->
    <div class="panel">
        <h2>Tips: Data Bachana Zaroori Hai</h2>
        <p>Aapka data sirf isi browser aur isi device me save hota hai. Agar aap browser ka data (history, cache) clear karenge, toh yeh data bhi khatam ho jayega. Apne data ko hamesha mehfooz rakhne ke liye neeche diye gaye tareeqon par amal karein:</p>
        
        <ol>
            <li>
                <strong>Export JSON File:</strong><br>
                Upar "Export JSON" button par click kar ke data ki ek file download karein. Yeh file aapke computer ya mobile par save ho jayegi. Aap is file ko Google Drive, USB ya email me rakh sakte hain.
            </li>
            <li>
                <strong>Import JSON File:</strong><br>
                Jab aapko data wapas lana ho, toh "Import JSON" button par click kar ke wohi file upload karein. Aapka saara data wapas aa jayega.
            </li>
            <li>
                <strong>Download Image:</strong><br>
                "Download Image" button se aap poore page ka ek screenshot le sakte hain. Isse aapke totals aur report ki ek image ban jayegi. Yeh ek quick backup ka tareeqa hai.
            </li>
        </ol>
        <p>In tips par amal kar ke aapka data hamesha mehfooz rahega, chahe aap galti se browser ka data clear hi kyun na kar dein.</p>
    </div>

  </main>

  <footer class="wrap footer">
    <div>Cash Management System | Works offline | Free to use | Data saved in your browser</div>
    <div style="margin-top:6px">¬©Copyright 2025 by I.T. Department of ALQAAB Web Studio by ALQAAB Org_Shahbaz Ali</div>
  </footer>

  <!-- html2canvas library for screenshot functionality -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <script>
    // --- Constants ---
    const RATES = { r425: 4.25, r475: 4.75, r600: 6.0 };
    const PER_BORI_DOZEN = 60;
    const STORAGE_KEY = 'gloves-manufacture-month-v3'; // Updated to v3 for new data structure
    const THEME_KEY = 'gloves-theme';
    const PROFILE_IMAGE_KEY = 'gloves-profile-image';

    // --- Theme ---
    function applyTheme(){
      const t = localStorage.getItem(THEME_KEY) || 'light';
      document.documentElement.classList.toggle('dark', t==='dark');
    }
    applyTheme();
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      const now = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
      localStorage.setItem(THEME_KEY, now);
      applyTheme();
    });

    // --- Helpers ---
    const fmt = n => (Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
    const sum = arr => arr.reduce((a,b)=>a+(Number(b)||0),0);

    function emptyMonth(){
      return {
        meta:{ 
          createdAt: new Date().toISOString(),
          userName: '',
          mobileNumber: '',
          month: new Date().getMonth(),
          year: new Date().getFullYear(),
          previousBalance: 0
        },
        days: Array.from({length:31}, (_,i)=>({
          day:i+1, q425:0, q475:0, q600:0, note:''
        })),
        payments: []
      };
    }

    // --- State ---
    let state = load();

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return emptyMonth();
        const data = JSON.parse(raw);
        
        // Handle migration from previous versions
        if(!data.payments) data.payments = [];
        if(!data.meta.previousBalance) data.meta.previousBalance = 0;
        
        // Ensure each payment has a date
        data.payments.forEach(payment => {
          if (!payment.date) payment.date = new Date().toISOString().split('T')[0];
        });
        
        if(!data.days || data.days.length!==31) return emptyMonth();
        return data;
      }catch(e){
        return emptyMonth();
      }
    }

    function save(){
      state.meta.lastSaved = new Date().toISOString();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      document.getElementById('lastSaved').value = new Date(state.meta.lastSaved).toLocaleString();
      document.getElementById('statusIndicator').value = "All changes saved";
      
      // Update profile info
      updateProfileInfo();
    }

    // Update profile information display
    function updateProfileInfo() {
      // This function is now used to initialize inputs, not just display text
      document.getElementById('userName').value = state.meta.userName || '';
      document.getElementById('mobileNumber').value = state.meta.mobileNumber || '';
      document.getElementById('previousBalance').value = state.meta.previousBalance || 0;
      
      // Load profile image if available
      const profileImage = localStorage.getItem(PROFILE_IMAGE_KEY);
      if (profileImage) {
        document.getElementById('profileImage').src = profileImage;
      }
    }

    // --- Build Monthly Table ---
    const tbody = document.querySelector('#monthTable tbody');

    function rowAmount(qty, rate){
      return (Number(qty)||0) * rate * PER_BORI_DOZEN;
    }

    function makeRow(dayObj){
      const tr = document.createElement('tr');
      // Adding a new class to the input cells for centering
      tr.innerHTML = `
        <td>${dayObj.day}</td>
        <td class="table-input-cell"><input type="number" min="0" step="1" data-bind="q425" value="${dayObj.q425 || ''}"></td>
        <td class="table-input-cell"><input type="number" min="0" step="1" data-bind="q475" value="${dayObj.q475 || ''}"></td>
        <td class="table-input-cell"><input type="number" min="0" step="1" data-bind="q600" value="${dayObj.q600 || ''}"></td>
        <td class="mono" data-bind="dayTotal">0.00</td>
        <td class="table-input-cell"><input type="text" data-bind="note" value="${dayObj.note||''}" placeholder="Note"></td>
      `;

      function recalc(){
        const q425 = Number(tr.querySelector('input[data-bind="q425"]').value)||0;
        const q475 = Number(tr.querySelector('input[data-bind="q475"]').value)||0;
        const q600 = Number(tr.querySelector('input[data-bind="q600"]').value)||0;
        const a425 = rowAmount(q425, RATES.r425);
        const a475 = rowAmount(q475, RATES.r475);
        const a600 = rowAmount(q600, RATES.r600);
        tr.querySelector('[data-bind="dayTotal"]').textContent = fmt(a425+a475+a600);
      }

      tr.addEventListener('input', (e)=>{
        const el = e.target;
        const key = el.getAttribute('data-bind');
        const idx = dayObj.day - 1;
        if(['q425','q475','q600'].includes(key)){
          state.days[idx][key] = Number(el.value)||0;
        } else if(key==='note'){
          state.days[idx].note = el.value;
        }
        recalc();
        totals();
        document.getElementById('statusIndicator').value = "Saving...";
        save();
      });

      recalc();
      return tr;
    }

    function buildPayments(){
      const container = document.getElementById('paymentsContainer');
      container.innerHTML = '';
      
      if(state.payments.length === 0) {
        container.innerHTML = '<p class="note">No payments added yet.</p>';
        return;
      }
      
      state.payments.forEach((payment, index) => {
        const paymentEl = document.createElement('div');
        paymentEl.className = 'payment-details';
        paymentEl.innerHTML = `
          <input type="date" value="${payment.date}" readonly class="mono payment-date" />
          <input type="number" value="${payment.amount}" readonly class="mono" />
          <input type="text" value="${payment.note}" readonly class="payment-note" />
          <button class="btn warn delete-payment" data-index="${index}">Delete</button>
        `;
        container.appendChild(paymentEl);
      });
      
      // Add event listeners for delete buttons
      document.querySelectorAll('.delete-payment').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.getAttribute('data-index'));
          state.payments.splice(index, 1);
          buildPayments();
          totals();
          document.getElementById('statusIndicator').value = "Saving...";
          save();
        });
      });
    }

    function build(){
      tbody.innerHTML = '';
      state.days.forEach(d=> tbody.appendChild(makeRow(d)) );
      totals();
      if(state.meta.lastSaved){
        document.getElementById('lastSaved').value = new Date(state.meta.lastSaved).toLocaleString();
      }
      
      // Load user info
      document.getElementById('userName').value = state.meta.userName || '';
      document.getElementById('mobileNumber').value = state.meta.mobileNumber || '';
      document.getElementById('monthSelect').value = state.meta.month || new Date().getMonth();
      document.getElementById('yearInput').value = state.meta.year || new Date().getFullYear();
      document.getElementById('previousBalance').value = state.meta.previousBalance || 0;
      
      // Set default date for new payments to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('newPaymentDate').value = today;
      
      // Build payments
      buildPayments();
      
      // Update profile info
      updateProfileInfo();
    }

    function totals(){
      const q425s = state.days.map(d=>Number(d.q425)||0);
      const q475s = state.days.map(d=>Number(d.q475)||0);
      const q600s = state.days.map(d=>Number(d.q600)||0);

      const A425 = sum(q425s)*RATES.r425*PER_BORI_DOZEN;
      const A475 = sum(q475s)*RATES.r475*PER_BORI_DOZEN;
      const A600 = sum(q600s)*RATES.r600*PER_BORI_DOZEN;
      const GT = A425 + A475 + A600;
      
      // Calculate total payments
      const totalPayments = state.payments.reduce((sum, payment) => sum + Number(payment.amount), 0);
      
      // Calculate final amount with previous balance and payments
      const prevBalance = Number(state.meta.previousBalance) || 0;
      const finalAmount = GT + prevBalance - totalPayments;

      // Footer row
      document.getElementById('sumQ425').textContent = sum(q425s);
      document.getElementById('sumQ475').textContent = sum(q475s);
      document.getElementById('sumQ600').textContent = sum(q600s);
      document.getElementById('sumDay').textContent  = fmt(GT);

      // Totals cards
      document.getElementById('totalQ425').value = sum(q425s);
      document.getElementById('totalA425').value = fmt(A425);
      document.getElementById('totalQ475').value = sum(q475s);
      document.getElementById('totalA475').value = fmt(A475);
      document.getElementById('totalQ600').value = sum(q600s);
      document.getElementById('totalA600').value = fmt(A600);
      document.getElementById('grandTotal').value = fmt(GT);
      document.getElementById('prevBalanceDisplay').value = fmt(prevBalance);
      document.getElementById('totalPayments').value = fmt(totalPayments);
      document.getElementById('finalAmount').value = fmt(finalAmount);
    }

    build();
    save();

    // --- Quick Calculator ---
    function setupQuick(qId, aId, rate){
      const q = document.getElementById(qId);
      const a = document.getElementById(aId);
      function calc(){ 
        a.value = fmt((Number(q.value)||0) * rate * PER_BORI_DOZEN);
        updateQuickTotals();
      }
      q.addEventListener('input', calc); 
      calc();
    }
    
    function updateQuickTotals(){
      const q425 = Number(document.getElementById('q425Quick').value) || 0;
      const q475 = Number(document.getElementById('q475Quick').value) || 0;
      const q600 = Number(document.getElementById('q600Quick').value) || 0;
      
      const totalBories = q425 + q475 + q600;
      const totalAmount = (q425 * RATES.r425 + q475 * RATES.r475 + q600 * RATES.r600) * PER_BORI_DOZEN;
      
      document.getElementById('totalBoriesQuick').value = totalBories;
      document.getElementById('totalAmountQuick').value = fmt(totalAmount);
    }
    
    setupQuick('q425Quick', 'a425Quick', RATES.r425);
    setupQuick('q475Quick', 'a475Quick', RATES.r475);
    setupQuick('q600Quick', 'a600Quick', RATES.r600);

    // --- User Info Handling ---
    document.getElementById('userName').addEventListener('input', (e)=>{
      state.meta.userName = e.target.value;
      document.getElementById('statusIndicator').value = "Saving...";
      save();
    });
    
    document.getElementById('mobileNumber').addEventListener('input', (e)=>{
      state.meta.mobileNumber = e.target.value;
      document.getElementById('statusIndicator').value = "Saving...";
      save();
    });
    
    document.getElementById('monthSelect').addEventListener('change', (e)=>{
      state.meta.month = parseInt(e.target.value);
      document.getElementById('statusIndicator').value = "Saving...";
      save();
    });
    
    document.getElementById('yearInput').addEventListener('input', (e)=>{
      state.meta.year = parseInt(e.target.value);
      document.getElementById('statusIndicator').value = "Saving...";
      save();
    });
    
    document.getElementById('previousBalance').addEventListener('input', (e)=>{
      state.meta.previousBalance = Number(e.target.value) || 0;
      totals();
      document.getElementById('statusIndicator').value = "Saving...";
      save();
    });

    // --- Profile Image Upload ---
    document.getElementById('profileUpload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const imgData = event.target.result;
          document.getElementById('profileImage').src = imgData;
          localStorage.setItem(PROFILE_IMAGE_KEY, imgData);
        };
        reader.readAsDataURL(file);
      }
    });

    // --- Payment Handling ---
    document.getElementById('addPaymentBtn').addEventListener('click', ()=>{
      const date = document.getElementById('newPaymentDate').value;
      const amount = Number(document.getElementById('newPaymentAmount').value) || 0;
      const note = document.getElementById('newPaymentNote').value.trim() || 'Payment';
      
      if(amount > 0) {
        state.payments.push({
          date: date,
          amount: amount,
          note: note
        });
        
        document.getElementById('newPaymentAmount').value = '';
        document.getElementById('newPaymentNote').value = '';
        
        buildPayments();
        totals();
        document.getElementById('statusIndicator').value = "Saving...";
        save();
      }
    });

    // --- Export / Import / Reset ---
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `gloves-manufacture-${stamp}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          if(!data.days || data.days.length!==31) throw new Error('Invalid file');
          
          // Handle migration from previous versions
          if(!data.payments) data.payments = [];
          if(!data.meta.previousBalance) data.meta.previousBalance = 0;
          
          // Ensure each payment has a date
          data.payments.forEach(payment => {
            if (!payment.date) payment.date = new Date().toISOString().split('T')[0];
          });
          
          state = data; build(); save();
          // DO NOT USE alert().
          // Replacing alert() with a custom modal or message.
          const msg = "Import successful.";
          const statusEl = document.getElementById('statusIndicator');
          const originalValue = statusEl.value;
          statusEl.value = msg;
          setTimeout(() => { statusEl.value = originalValue; }, 3000);

        }catch(err){
          // DO NOT USE alert().
          // Replacing alert() with a custom modal or message.
          const msg = 'Import failed. Make sure you selected the correct JSON file.';
          const statusEl = document.getElementById('statusIndicator');
          const originalValue = statusEl.value;
          statusEl.value = msg;
          setTimeout(() => { statusEl.value = originalValue; }, 3000);
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      // DO NOT USE confirm().
      // Using a custom modal/message box logic.
      const shouldReset = true; // Placeholder for a custom confirmation dialog.
      if(shouldReset){
        state = emptyMonth(); build(); save();
      }
    });

    // --- Image Download ---
    document.getElementById('downloadImageBtn').addEventListener('click', ()=>{
      // Get the full height of the content to be captured
      const mainContent = document.getElementById('mainContent');
      const originalHeight = mainContent.style.height;
      
      // Temporarily set height to auto to capture full content
      mainContent.style.height = 'auto';

      // Capture the main content area
      html2canvas(mainContent, {
        allowTaint: true,
        useCORS: true,
        scrollX: 0,
        scrollY: -window.scrollY // Capture from the top of the element
      }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        const date = new Date();
        const fileName = `gloves-report-${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}.png`;
        
        link.href = imgData;
        link.download = fileName;
        link.click();

        // Restore the original height
        mainContent.style.height = originalHeight;
      });
    });


    // --- Offline (Service Worker in single file via Blob) ---
    if('serviceWorker' in navigator){
      const swCode = `
        const CACHE = 'gloves-cache-v1';
        self.addEventListener('install', e=>{
          e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
          self.skipWaiting();
        });
        self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
        self.addEventListener('fetch', e=>{
          const req = e.request;
          e.respondWith(
            caches.match(req).then(res=> res || fetch(req).then(r=>re=>{
              const copy = r.clone();
              caches.open(CACHE).then(c=>c.put(req, copy)).catch(()=>{});
              return r;
            }).catch(()=>caches.match('./')))
          );
        });
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).catch(()=>{});
    }
  </script>
</body>
</html>
